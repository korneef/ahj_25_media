(()=>{"use strict";function e(e,t,s){const o=document.createElement(e);return void 0!==t&&o.classList.add(t),void 0!==s&&(o.textContent=s),o}class t{constructor(){this.messenger=document.querySelector(".messenger-wrapper"),this.message={},this.popower=null,this.addListenersToPage=this.addListenersToPage.bind(this),this.getPosition=this.getPosition.bind(this),this.handleGetPositionError=this.handleGetPositionError.bind(this)}init(){this.addListenersToPage(),this.getMessagesFromLocalStorage()}addListenersToPage(){const e=document.querySelector(".messenger__new-message-form");e.addEventListener("submit",(t=>{t.preventDefault(),this.message.text=e[0].value,this.message.date=`${function(e){const t=new Date(e);let s=t.getDate();s<10&&(s=`0${s}`);let o=t.getMonth();o<10&&(o=`0${o}`);const i=t.getFullYear();let r=t.getHours();r<10&&(r=`0${r}`);let a=t.getMinutes();return a<10&&(a=`0${a}`),`${s}.${o}.${i} ${r}:${a}`}(Date.now())}`,this.button=e[1],this.button.setAttribute("disabled",""),navigator.geolocation.getCurrentPosition(this.getPosition,this.handleGetPositionError)})),document.querySelector(".geo-fail__cancel").addEventListener("click",(()=>{const e=document.querySelector(".geo-fail-wrapper");e.querySelector(".geo-fail__textarea").value="",e.classList.add("invisible"),this.popower.classList.add("invisible")})),document.querySelector(".geo-fail").addEventListener("submit",(e=>{e.preventDefault();let t=e.target[0].value;/^(((\[{0,1}-{0,1}\d{1,2})|(\[{0,1}-{0,1}1[0-7]\d{1}))\.\d{1,8}),\s{0,1}-{0,1}((1[0-7]\d{1})|(\d{1,2}))\.\d{1,8}(\]{0,1}$)/.test(t)?(t=t.replace("[",""),t=t.replace("]",""),t=t.replace(", ",","),t=t.replace(",",", "),this.message.coords=`[${t}]`,this.localstorageSetter("messages",this.message),this.postMessage(this.message),this.popower.classList.add("invisible"),document.querySelector(".geo-fail-wrapper").classList.add("invisible"),this.messenger.querySelector(".messenger__new-message-textarea").value=""):null===this.popower?this.createGeoFailPopower():this.popower.classList.remove("invisible")})),document.querySelector(".geo-fail__textarea").addEventListener("keydown",(()=>{this.popower&&this.popower.classList.add("invisible")}))}postMessage(t){const s=this.messenger.querySelector(".messenger__messages"),o=e("div","messenger__message"),i=e("div","messenger__message-data",t.date),r=e("div","messenger__message-content",t.text),a=e("div","messenger__message-geo",t.coords);o.appendChild(i),o.appendChild(r),o.appendChild(a),s.insertAdjacentElement("afterbegin",o)}getPosition(e){const{latitude:t,longitude:s}=e.coords;this.message.coords=`[${t}, ${s}]`,this.localstorageSetter("messages",this.message),this.postMessage(this.message),this.button.removeAttribute("disabled")}handleGetPositionError(){this.button.removeAttribute("disabled"),document.querySelector(".geo-fail-wrapper").classList.remove("invisible")}localstorageSetter(e,t){const s=JSON.parse(localStorage.getItem(e));if(null===s){const s=[t];localStorage.setItem(e,JSON.stringify(s))}else s.push(t),localStorage.setItem(e,JSON.stringify(s))}localStorageGetter(e){const t=JSON.parse(localStorage.getItem(e));return null===t?[]:t}getMessagesFromLocalStorage(){const e=this.localStorageGetter("messages");for(let t=0;t<e.length;t+=1)this.postMessage(e[t])}createGeoFailPopower(){this.popower=e("div","geo-fail__popower-form");const t=e("div",void 0,"Такой геопозиции не существует");t.style.backgroundColor="rgb(230, 230, 230)",t.style.borderRadius="5px 5px 0 0",t.style.borderBottom="1px solid rgb(58, 58, 58)";const s=e("div",void 0,"Введите координаты в формате XX.XXXXXX, YY.YYYYYY");this.popower.appendChild(t),this.popower.appendChild(s);const o=document.getElementsByClassName("geo-fail__textarea")[0];o.offsetParent.appendChild(this.popower),this.popower.style.top=o.offsetTop-this.popower.offsetHeight+"px",this.popower.style.left=o.offsetLeft+o.offsetWidth/2-this.popower.offsetWidth/2+"px"}}document.addEventListener("DOMContentLoaded",(()=>{(new t).init()}))})();